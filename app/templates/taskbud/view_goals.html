{% extends "base.html" %}

{% block title %}{{ goal.title }} | TaskBud{% endblock %}

{% block additional_styles %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
    /* =============== VARIABLES =============== */
    :root {
        --priority-high: var(--bs-danger);
        --priority-medium: var(--bs-warning);
        --priority-low: var(--bs-primary);
        --ai-color: #6f42c1;
        --ai-light: rgba(111, 66, 193, 0.1);
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --card-hover-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        --transition-standard: all 0.3s ease;
    }

    [data-theme="dark"] {
        --card-bg: rgba(30, 41, 59, 0.5);
        --card-hover-bg: rgba(30, 41, 59, 0.7);
    }

    /* =============== LAYOUT =============== */
    .container {
        max-width: 1200px;
    }

    /* =============== PROGRESS CIRCLE =============== */
    .progress-circle {
        position: relative;
        width: 140px;
        height: 140px;
        margin: 0 auto;
        filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.1));
    }

    .progress-circle svg {
        width: 100%;
        height: 100%;
    }

    .progress-circle .circle {
        stroke: #dee2e6;
        stroke-width: 5px;
        fill: none;
    }

    .progress-circle .progress {
        stroke-width: 5px;
        stroke-linecap: round;
        fill: none;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        transition: stroke-dashoffset 1s ease;
    }

    .progress-circle .percentage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.75rem;
        font-weight: bold;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .progress-circle .percentage small {
        font-size: 0.825rem;
        opacity: 0.7;
        font-weight: normal;
        margin-top: 0.25rem;
    }

    /* =============== PRIORITY INDICATORS =============== */
    .priority-1 { border-left: 4px solid var(--priority-high); }
    .priority-2 { border-left: 4px solid var(--priority-medium); }
    .priority-3 { border-left: 4px solid var(--priority-low); }

    /* =============== TASK ITEMS =============== */
    .task-item {
        transition: var(--transition-standard);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
    }

    .task-item:hover {
        background-color: rgba(13, 110, 253, 0.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .task-completed, .completed {
        opacity: 0.75;
        text-decoration: line-through;
    }

    /* =============== BADGES & TAGS =============== */
    .badge-pill {
        padding: 0.35em 0.75em;
        border-radius: 50rem;
        font-weight: 500;
    }

    .tag {
        display: inline-block;
        padding: 0.25em 0.65em;
        border-radius: 50rem;
        margin: 0.25rem 0.5rem 0.25rem 0;
        font-size: 0.75rem;
        font-weight: 500;
        background-color: var(--bs-gray-200);
        color: var(--bs-gray-700);
        transition: var(--transition-standard);
    }
    
    .tag:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* =============== GOAL DESCRIPTION =============== */
    .goal-description {
        white-space: pre-line;
        line-height: 1.6;
    }

    /* =============== BUTTONS =============== */
    .btn-hover-translate {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-hover-translate:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-ai {
        background-color: var(--ai-color);
        color: white;
        border: none;
    }
    
    .btn-ai:hover {
        background-color: #5e35b1;
        color: white;
        box-shadow: 0 4px 10px rgba(111, 66, 193, 0.3);
    }

    .action-btn {
        transition: transform 0.2s ease;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        padding: 0;
    }

    .action-btn:hover {
        transform: scale(1.1);
        background-color: rgba(0, 0, 0, 0.05);
    }

    /* =============== CARDS =============== */
    .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: var(--card-shadow);
        transition: var(--transition-standard);
        border-radius: 12px;
    }
    
    .card:hover {
        box-shadow: var(--card-hover-shadow);
    }

    .sub-goal-card {
        transition: var(--transition-standard);
        height: 100%;
    }

    .sub-goal-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--card-hover-shadow);
    }

    /* =============== FORM ELEMENTS =============== */
    .form-check-input {
        width: 1.2em;
        height: 1.2em;
        cursor: pointer;
        border-color: rgba(0, 0, 0, 0.2);
    }
    
    .form-check-input:checked {
        background-color: var(--bs-success);
        border-color: var(--bs-success);
    }
    
    .form-check-label {
        cursor: pointer;
    }

    /* =============== ANIMATIONS =============== */
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    .slide-in { animation: slideIn 0.5s ease-in-out; }
    .pulse { animation: pulse 2s infinite; }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .task-complete-animation {
        animation: completeTask 0.5s forwards;
    }

    @keyframes completeTask {
        0% { background-color: transparent; }
        50% { background-color: rgba(25, 135, 84, 0.1); }
        100% { background-color: transparent; }
    }

    /* =============== MODAL STYLING =============== */
    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .ai-modal .modal-header {
        background: linear-gradient(135deg, var(--ai-color), #5e35b1);
        color: white;
        border-bottom: none;
    }
    
    .ai-modal .modal-title i {
        margin-right: 0.5rem;
    }
    
    .modal-body::-webkit-scrollbar {
        width: 8px;
    }

    .modal-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .modal-body::-webkit-scrollbar-thumb {
        background: #b8b8b8;
        border-radius: 10px;
    }

    .modal-body::-webkit-scrollbar-thumb:hover {
        background: #888;
    }
    
    /* =============== AI TASK GENERATION =============== */
    .ai-suggestion-wrapper {
        border: 1px solid rgba(111, 66, 193, 0.2);
        border-radius: 10px;
        transition: var(--transition-standard);
        margin-bottom: 1rem;
        background-color: rgba(111, 66, 193, 0.03);
    }
    
    .ai-suggestion-wrapper:hover {
        border-color: var(--ai-color);
        box-shadow: 0 4px 12px rgba(111, 66, 193, 0.15);
        transform: translateY(-2px);
    }
    
    .ai-badge {
        background-color: var(--ai-light);
        color: var(--ai-color);
    }
    
    /* =============== RESPONSIVE ADJUSTMENTS =============== */
    @media (max-width: 768px) {
        .progress-circle {
            width: 120px;
            height: 120px;
        }
        
        .goal-action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }
        
        .goal-meta-line {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Back Navigation -->
    <div class="mb-4">
        <a href="{{ url_for('taskbud.goals') }}" class="text-decoration-none text-primary d-flex align-items-center">
            <i class="bi bi-arrow-left me-2"></i> Back to Goals
        </a>
    </div>

    <!-- Goal Header Card -->
    <div class="card shadow-sm mb-4 fade-in">
        <div class="card-body p-4">
            <div class="row align-items-start">
                <div class="col-lg-8">
                    <div class="d-flex align-items-center mb-3">
                        <h1 class="fs-2 fw-bold me-3 mb-0">{{ goal.title }}</h1>
                        <span class="badge badge-pill {% if goal.status == 'active' %}bg-primary{% elif goal.status == 'completed' %}bg-success{% elif goal.status == 'on_hold' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {{ goal.status|title }}
                        </span>
                    </div>

                    <div class="d-flex flex-wrap gap-3 mb-3 goal-meta-line">
                        <span class="d-flex align-items-center text-secondary">
                            <i class="bi bi-graph-up me-1"></i>
                            {{ goal.goal_type|replace('_', ' ')|title }}
                        </span>
                        <span class="d-flex align-items-center {% if goal.priority == 1 %}text-danger{% elif goal.priority == 2 %}text-warning{% else %}text-primary{% endif %}">
                            <i class="bi bi-star-fill me-1"></i>
                            {{ {1: 'High', 2: 'Medium', 3: 'Low'}[goal.priority] }} Priority
                        </span>
                        {% if goal.target_date %}
                        <span class="d-flex align-items-center {% if goal.is_overdue() %}text-danger{% else %}text-secondary{% endif %}">
                            <i class="bi {% if goal.is_overdue() %}bi-calendar-x{% else %}bi-calendar-event{% endif %} me-1"></i>
                            {% if goal.is_overdue() %}
                                Overdue: {{ goal.target_date.strftime('%b %d, %Y') }}
                            {% else %}
                                Target: {{ goal.target_date.strftime('%b %d, %Y') }}
                            {% endif %}
                        </span>
                        {% endif %}
                        {% if goal.created_at %}
                        <span class="d-flex align-items-center text-secondary">
                            <i class="bi bi-clock-history me-1"></i>
                            Created: {{ goal.created_at.strftime('%b %d, %Y') }}
                        </span>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <h5 class="fw-semibold text-dark mb-2">
                            <i class="bi bi-file-text me-2 text-primary"></i>Description
                        </h5>
                        <p class="text-secondary goal-description">{{ goal.description or 'No description provided.' }}</p>
                        {% if goal.parent_goal %}
                        <div class="p-3 bg-light rounded-3 mt-3">
                            <h6 class="fw-semibold text-dark mb-1">
                                <i class="bi bi-diagram-3 me-2 text-primary"></i>Part of goal:
                            </h6>
                            <a href="{{ url_for('taskbud.view_goal', goal_id=goal.parent_goal.id) }}" class="text-decoration-none text-primary">
                                {{ goal.parent_goal.title }}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Progress Circle and Stats -->
                <div class="col-lg-4 d-flex flex-column align-items-center">
                    <div class="progress-circle mb-3">
                        <svg viewBox="0 0 140 140">
                            <circle cx="70" cy="70" r="60" class="circle"/>
                            <circle cx="70" cy="70" r="60" class="progress"
                                    style="stroke: {% if goal.progress < 25 %}var(--bs-danger){% elif goal.progress < 50 %}var(--bs-warning){% elif goal.progress < 75 %}var(--bs-primary){% else %}var(--bs-success){% endif %};"
                                    stroke-dasharray="376.99"
                                    stroke-dashoffset="{{ 376.99 * (1 - goal.progress/100)|float }}"/>
                        </svg>
                        <div class="percentage">
                            {{ goal.progress|round|int }}%
                            <small>complete</small>
                        </div>
                    </div>

                    <div class="text-center goal-progress-section mb-3">
                        <p class="text-secondary mb-2">
                            <i class="bi bi-check2-square me-1"></i>
                            {{ goal.tasks|selectattr('completed')|list|length }}/{{ goal.tasks|length }} tasks completed
                        </p>
                        {% if goal.days_remaining() is not none %}
                        <p class="{% if goal.is_overdue() %}text-danger{% else %}text-secondary{% endif %} d-flex align-items-center justify-content-center">
                            <i class="bi {% if goal.is_overdue() %}bi-exclamation-triangle{% else %}bi-calendar-check{% endif %} me-1"></i>
                            {% if goal.is_overdue() %}
                                Overdue by {{ (goal.days_remaining() * -1) }} days
                            {% else %}
                                {{ goal.days_remaining() }} days remaining
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-2 mt-2 goal-action-buttons">
                        <a href="{{ url_for('taskbud.edit_goal', goal_id=goal.id) }}" class="btn btn-outline-primary btn-hover-translate">
                            <i class="bi bi-pencil me-1"></i> Edit
                        </a>
                        {% if goal.status != 'completed' %}
                        <form method="POST" action="{{ url_for('taskbud.complete_goal', goal_id=goal.id) }}" class="complete-goal-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit" class="btn btn-outline-success btn-hover-translate">
                                <i class="bi bi-check-lg me-1"></i> Complete
                            </button>
                        </form>
                        {% endif %}
                        <button type="button" class="delete-goal-btn btn btn-outline-danger btn-hover-translate">
                            <i class="bi bi-trash me-1"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-goals Section -->
    {% if sub_goals %}
    <div class="mb-4 slide-in">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="fs-4 fw-bold mb-0">
                <i class="bi bi-diagram-3 me-2 text-primary"></i>Sub-Goals
            </h2>
            <a href="{{ url_for('taskbud.new_goal') }}?parent_id={{ goal.id }}" class="btn btn-outline-primary btn-sm btn-hover-translate">
                <i class="bi bi-plus-lg me-1"></i> Add Sub-Goal
            </a>
        </div>
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
            {% for sub_goal in sub_goals %}
            <div class="col">
                <div class="card h-100 shadow-sm sub-goal-card priority-{{ sub_goal.priority }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <a href="{{ url_for('taskbud.view_goal', goal_id=sub_goal.id) }}" class="fs-5 fw-semibold text-decoration-none text-dark stretched-link">
                                {{ sub_goal.title }}
                            </a>
                            <span class="badge badge-pill {% if sub_goal.status == 'active' %}bg-primary{% elif sub_goal.status == 'completed' %}bg-success{% elif sub_goal.status == 'on_hold' %}bg-warning{% else %}bg-secondary{% endif %}">
                                {{ sub_goal.status|title }}
                            </span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar
                                {% if sub_goal.progress < 25 %}bg-danger{% elif sub_goal.progress < 50 %}bg-warning{% elif sub_goal.progress < 75 %}bg-primary{% else %}bg-success{% endif %}"
                                role="progressbar"
                                style="width: {{ sub_goal.progress }}%;"
                                aria-valuenow="{{ sub_goal.progress|round|int }}"
                                aria-valuemin="0"
                                aria-valuemax="100">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-secondary">
                                <i class="bi bi-check2-square"></i> {{ sub_goal.tasks|selectattr('completed')|list|length }}/{{ sub_goal.tasks|length }} tasks
                            </small>
                            <small class="text-secondary">{{ sub_goal.progress|round|int }}% complete</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Tasks Section -->
    <div class="mb-4 fade-in" id="tasks">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="fs-4 fw-bold">
                <i class="bi bi-check2-square me-2 text-primary"></i>Tasks
            </h2>
            <div class="d-flex gap-2">
                <a href="{{ url_for('taskbud.new_task', goal_id=goal.id) }}" class="btn btn-primary btn-hover-translate">
                    <i class="bi bi-plus-lg me-1"></i> Add Task
                </a>
                <button id="generateTasksBtn" class="btn btn-ai btn-hover-translate">
                    <i class="bi bi-magic me-1"></i> Generate AI Tasks
                </button>
            </div>
        </div>

        <div class="card shadow-sm" id="tasks-container">
            {% if tasks %}
            <div class="list-group list-group-flush">
                {% for task in tasks %}
                <div class="list-group-item task-item task-card p-3 {% if task.completed %}completed{% endif %} priority-{{ task.priority }}" id="task-{{ task.id }}">
                    <div class="d-flex">
                        <div class="me-3 pt-1">
                            <form class="complete-task-form" action="{{ url_for('taskbud.complete_task', task_id=task.id) }}" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <input type="checkbox" class="form-check-input task-checkbox"
                                    data-task-id="{{ task.id }}"
                                    id="task-check-{{ task.id }}"
                                    {% if task.completed %}checked disabled{% endif %}>
                            </form>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <label for="task-check-{{ task.id }}" class="form-check-label fw-medium mb-1 {% if task.completed %}text-decoration-line-through{% endif %}">
                                        {{ task.title }}
                                        {% if task.is_ai_generated %}
                                        <span class="badge rounded-pill ai-badge ms-2" title="AI Generated">
                                            <i class="bi bi-robot"></i>
                                        </span>
                                        {% endif %}
                                    </label>
                                    {% if task.description %}
                                    <p class="text-secondary small mb-1">{{ task.description }}</p>
                                    {% endif %}
                                    {% if task.tags %}
                                    <div class="mt-1">
                                        {% for tag in task.get_tags_list() %}
                                        <span class="tag">{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="d-flex flex-column align-items-end">
                                    <span class="badge badge-pill bg-{% if task.priority == 1 %}danger{% elif task.priority == 2 %}warning{% else %}primary{% endif %}-subtle text-{% if task.priority == 1 %}danger{% elif task.priority == 2 %}warning{% else %}primary{% endif %} mb-1">
                                        {{ {1: 'High', 2: 'Medium', 3: 'Low'}[task.priority] }}
                                    </span>
                                    {% if task.due_date %}
                                    <small class="{% if task.is_overdue() %}text-danger{% else %}text-secondary{% endif %} mb-1">
                                        <i class="bi bi-calendar-date me-1"></i>
                                        {{ task.due_date.strftime('%b %d, %Y') }}
                                    </small>
                                    {% endif %}
                                    {% if task.estimated_hours %}
                                    <small class="text-secondary">
                                        <i class="bi bi-clock me-1"></i>
                                        {{ task.estimated_hours }} hours
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mt-2 gap-2">
                                <a href="{{ url_for('taskbud.edit_task', task_id=task.id) }}" class="btn btn-sm btn-link text-secondary action-btn">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button class="delete-task-btn btn btn-sm btn-link text-danger action-btn" data-task-id="{{ task.id }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body p-5 text-center">
                <i class="bi bi-clipboard2 fs-1 text-secondary mb-3"></i>
                <h3 class="fs-5 fw-semibold mb-2">No tasks yet</h3>
                <p class="text-secondary mb-4">Break down your goal into manageable tasks</p>
                <div class="d-flex justify-content-center gap-2">
                    <a href="{{ url_for('taskbud.new_task', goal_id=goal.id) }}" class="btn btn-primary btn-hover-translate">
                        <i class="bi bi-plus-lg me-1"></i> Add Task
                    </a>
                    <button id="emptyStateGenerateBtn" class="btn btn-ai btn-hover-translate">
                        <i class="bi bi-magic me-1"></i> Generate AI Tasks
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Goal Modal -->
<div class="modal fade" id="delete-goal-modal" tabindex="-1" aria-labelledby="deleteGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteGoalModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i> Delete Goal
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the goal "<strong>{{ goal.title }}</strong>"?</p>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> This action cannot be undone and will permanently delete this goal and all associated tasks.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('taskbud.delete_goal', goal_id=goal.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button type="submit" class="btn btn-danger">Delete Goal</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Task Modal -->
<div class="modal fade" id="delete-task-modal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTaskModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i> Delete Task
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this task? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="delete-task-form" method="POST" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button type="submit" class="btn btn-danger">Delete Task</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- AI Task Generation Modal -->
<div class="modal fade ai-modal" id="aiTaskModal" tabindex="-1" aria-labelledby="aiTasksModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiTasksModalLabel">
                    <i class="bi bi-robot"></i> AI Task Generation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="aiLoading" class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-secondary mb-0">Generating intelligent task suggestions for "{{ goal.title }}"...</p>
                    <p class="text-secondary small mt-2">This may take a few seconds as we analyze your goal and personalize tasks to your needs.</p>
                </div>
                <div id="aiTaskResults" class="d-none">
                    <div class="alert alert-primary d-flex align-items-start mb-4">
                        <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                        <div>
                            <p class="mb-1">I've analyzed your goal "<strong>{{ goal.title }}</strong>" and generated these personalized task suggestions.</p>
                            <p class="mb-0 small">Select the tasks you'd like to add to your goal and click "Add Selected Tasks".</p>
                        </div>
                    </div>
                    <p class="text-secondary mb-3">Select tasks to add to your goal:</p>
                    <div id="suggestedTasksList" class="mb-3"></div>
                </div>
                <div id="aiError" class="d-none text-center py-5">
                    <i class="bi bi-exclamation-triangle text-danger fs-1 mb-3"></i>
                    <p class="text-danger" id="aiErrorMessage">Error generating tasks. Please try again.</p>
                    <button id="retryGenerateBtn" class="btn btn-primary btn-hover-translate mt-3">
                        <i class="bi bi-arrow-clockwise me-2"></i> Try Again
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="addAllTasksBtn" type="button" class="btn btn-ai d-none">
                    <i class="bi bi-plus-lg me-1"></i> Add Selected Tasks
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Initialize Bootstrap Components
    const deleteGoalModal = new bootstrap.Modal(document.getElementById('delete-goal-modal'));
    const deleteTaskModal = new bootstrap.Modal(document.getElementById('delete-task-modal'));
    const aiTaskModal = new bootstrap.Modal(document.getElementById('aiTaskModal'));
    
    // Initialize any tooltips
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    if (tooltips.length) {
        tooltips.forEach(el => new bootstrap.Tooltip(el));
    }

    // Progress Circle Animation
    const progressCircle = document.querySelector('.progress-circle .progress');
    const percentage = parseInt(document.querySelector('.percentage').textContent);
    const circumference = 2 * Math.PI * 60;
    
    if (progressCircle) {
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = circumference * (1 - percentage / 100);
        
        // Add animation on page load
        setTimeout(() => {
            progressCircle.style.transition = 'stroke-dashoffset 1.5s ease-in-out';
        }, 100);
    }

    // Toast Notification System
    const showToast = (message, type = 'success') => {
        const toastContainer = document.querySelector('.toast-container') || 
            Object.assign(document.createElement('div'), {
                className: 'toast-container position-fixed bottom-0 end-0 p-3'
            });
            
        if (!document.body.contains(toastContainer)) {
            document.body.appendChild(toastContainer);
        }

        const toastEl = Object.assign(document.createElement('div'), {
            className: `toast align-items-center text-white bg-${type} border-0`,
            role: 'alert',
            'aria-live': 'assertive',
            'aria-atomic': 'true',
            innerHTML: `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `
        });

        toastContainer.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 5000 });
        toast.show();
        
        // Clean up after hiding
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    };

    // Display Flash Messages
    {% for category, message in get_flashed_messages(with_categories=true) %}
        showToast('{{ message }}', '{{ category }}');
    {% endfor %}

    // Task Completion Handling
    document.querySelectorAll('.complete-task-form').forEach(form => {
        const checkbox = form.querySelector('.task-checkbox');
        
        if (checkbox && !checkbox.disabled) {
            checkbox.addEventListener('change', async (e) => {
                if (checkbox.checked) {
                    // Submit the form via AJAX
                    try {
                        const formAction = form.getAttribute('action');
                        const formData = new FormData(form);
                        const taskCard = form.closest('.task-card');
                        
                        // Add completion animation
                        taskCard.classList.add('task-complete-animation');
                        
                        const response = await fetch(formAction, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // Mark task as completed in UI
                            taskCard.classList.add('completed');
                            checkbox.disabled = true;
                            
                            // Update goal progress
                            const percentageEl = document.querySelector('.percentage');
                            if (percentageEl) {
                                percentageEl.innerHTML = `${Math.round(data.goal_progress)}%<small>complete</small>`;
                            }
                            
                            // Update progress circle
                            if (progressCircle) {
                                progressCircle.style.strokeDashoffset = circumference * (1 - data.goal_progress / 100);
                                
                                // Update color based on new progress
                                if (data.goal_progress < 25) {
                                    progressCircle.style.stroke = 'var(--bs-danger)';
                                } else if (data.goal_progress < 50) {
                                    progressCircle.style.stroke = 'var(--bs-warning)';
                                } else if (data.goal_progress < 75) {
                                    progressCircle.style.stroke = 'var(--bs-primary)';
                                } else {
                                    progressCircle.style.stroke = 'var(--bs-success)';
                                }
                                
                                // Add pulse effect
                                document.querySelector('.progress-circle').classList.add('pulse');
                                setTimeout(() => {
                                    document.querySelector('.progress-circle').classList.remove('pulse');
                                }, 2000);
                            }
                            
                            // Show success message
                            showToast('Task completed successfully!');
                            
                            // Update task counter
                            const taskCounter = document.querySelector('.goal-progress-section p:first-child');
                            if (taskCounter) {
                                const parts = taskCounter.textContent.split('/');
                                if (parts.length === 2) {
                                    const completed = parseInt(parts[0]) + 1;
                                    const total = parseInt(parts[1]);
                                    taskCounter.innerHTML = `<i class="bi bi-check2-square me-1"></i> ${completed}/${total} tasks completed`;
                                }
                            }
                        } else {
                            throw new Error('Failed to complete task');
                        }
                    } catch (error) {
                        console.error('Error completing task:', error);
                        showToast('Error completing task', 'danger');
                        
                        // Reset checkbox state
                        checkbox.checked = false;
                    }
                }
            });
        }
    });

    // Delete Goal Button
    const deleteGoalBtn = document.querySelector('.delete-goal-btn');
    if (deleteGoalBtn) {
        deleteGoalBtn.addEventListener('click', () => deleteGoalModal.show());
    }

    // Delete Task Buttons
    document.querySelectorAll('.delete-task-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const taskId = btn.dataset.taskId;
            document.getElementById('delete-task-form').action = 
                `{{ url_for('taskbud.delete_task', task_id=0) }}`.replace('0', taskId);
            deleteTaskModal.show();
        });
    });

    // ============= AI Task Generation System =============
    const generateTasksBtn = document.getElementById('generateTasksBtn');
    const emptyStateGenerateBtn = document.getElementById('emptyStateGenerateBtn');
    const aiLoading = document.getElementById('aiLoading');
    const aiTaskResults = document.getElementById('aiTaskResults');
    const aiError = document.getElementById('aiError');
    const suggestedTasksList = document.getElementById('suggestedTasksList');
    const addAllTasksBtn = document.getElementById('addAllTasksBtn');
    const retryGenerateBtn = document.getElementById('retryGenerateBtn');
    
    // Store generated tasks
    let aiGeneratedTasks = [];

    // Function to generate AI tasks
    const generateTasks = async () => {
        // Show modal and loading state
        aiTaskModal.show();
        aiLoading.classList.remove('d-none');
        aiTaskResults.classList.add('d-none');
        aiError.classList.add('d-none');
        addAllTasksBtn.classList.add('d-none');
        
        // Clear previous results
        suggestedTasksList.innerHTML = '';
        
        try {
            // Make API request to generate tasks
            const response = await fetch('{{ url_for("taskbud.api_generate_tasks") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ goal_id: {{ goal.id }} })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                // Store generated tasks for later use
                aiGeneratedTasks = data.tasks;
                
                // Switch to results view
                aiLoading.classList.add('d-none');
                aiTaskResults.classList.remove('d-none');
                addAllTasksBtn.classList.remove('d-none');
                
                // Create selection controls for multiple tasks
                if (data.tasks.length > 1) {
                    const selectionControls = document.createElement('div');
                    selectionControls.className = 'mb-3 d-flex justify-content-end gap-2';
                    selectionControls.innerHTML = `
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-tasks">
                            <i class="bi bi-check-all me-1"></i> Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-tasks">
                            <i class="bi bi-x me-1"></i> Deselect All
                        </button>
                    `;
                    suggestedTasksList.appendChild(selectionControls);
                    
                    // Add event listeners to selection buttons
                    document.getElementById('select-all-tasks').addEventListener('click', () => {
                        document.querySelectorAll('.task-select').forEach(cb => cb.checked = true);
                    });
                    
                    document.getElementById('deselect-all-tasks').addEventListener('click', () => {
                        document.querySelectorAll('.task-select').forEach(cb => cb.checked = false);
                    });
                }
                
                // Render task suggestions
                data.tasks.forEach((task, index) => {
                    // Create task suggestion card
                    const taskItem = document.createElement('div');
                    taskItem.className = 'ai-suggestion-wrapper p-3';
                    
                    // Get priority and difficulty labels
                    const priorityLabel = task.priority === 1 ? 'High' : task.priority === 2 ? 'Medium' : 'Low';
                    const priorityClass = task.priority === 1 ? 'danger' : task.priority === 2 ? 'warning' : 'primary';
                    const difficultyLabel = task.difficulty === 1 ? 'Easy' : task.difficulty === 2 ? 'Medium' : 'Hard';
                    
                    // Build task item HTML
                    taskItem.innerHTML = `
                        <div class="d-flex align-items-start">
                            <div class="form-check mt-1 me-2">
                                <input class="form-check-input task-select" type="checkbox" 
                                    id="task-select-${index}" data-index="${index}" checked>
                            </div>
                            <div class="flex-grow-1">
                                <label class="form-check-label fw-semibold mb-2" for="task-select-${index}">
                                    ${task.title}
                                    <span class="badge rounded-pill ai-badge ms-1" title="AI Generated">
                                        <i class="bi bi-robot"></i>
                                    </span>
                                </label>
                                
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    <span class="badge badge-pill bg-${priorityClass}-subtle text-${priorityClass}">
                                        <i class="bi bi-flag-fill me-1"></i> ${priorityLabel} Priority
                                    </span>
                                    ${task.due_date ? `
                                        <span class="badge badge-pill bg-secondary-subtle text-secondary">
                                            <i class="bi bi-calendar me-1"></i> Due: ${task.due_date}
                                        </span>
                                    ` : ''}
                                    ${task.estimated_hours ? `
                                        <span class="badge badge-pill bg-info-subtle text-info">
                                            <i class="bi bi-clock me-1"></i> ${task.estimated_hours} hours
                                        </span>
                                    ` : ''}
                                    ${task.difficulty ? `
                                        <span class="badge badge-pill bg-dark-subtle text-dark">
                                            <i class="bi bi-lightning-charge me-1"></i> ${difficultyLabel}
                                        </span>
                                    ` : ''}
                                </div>
                                
                                ${task.tags ? `
                                    <div class="small text-muted">
                                        <i class="bi bi-tags me-1"></i> Tags: ${task.tags.split(',').map(tag => 
                                            `<span class="tag small">${tag.trim()}</span>`
                                        ).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                    // Add to DOM
                    suggestedTasksList.appendChild(taskItem);
                });
            } else {
                throw new Error(data.error || 'Failed to generate tasks');
            }
        } catch (error) {
            console.error('Error generating tasks:', error);
            
            // Show error state
            aiLoading.classList.add('d-none');
            aiError.classList.remove('d-none');
            document.getElementById('aiErrorMessage').textContent = error.message || 'Error connecting to the server. Please try again.';
        }
    };

    // Add Selected Tasks Handler
    if (addAllTasksBtn) {
        addAllTasksBtn.addEventListener('click', async () => {
            // Get selected tasks
            const selectedCheckboxes = document.querySelectorAll('.task-select:checked');
            const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index));
            
            // Validate selection
            if (!selectedIndices.length) {
                // Show error message if no tasks selected
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-warning mt-3';
                errorAlert.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i> Please select at least one task.';
                
                aiTaskResults.appendChild(errorAlert);
                
                // Remove alert after delay
                setTimeout(() => errorAlert.remove(), 3000);
                return;
            }
            
            // Disable button and show loading state
            addAllTasksBtn.disabled = true;
            addAllTasksBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                Adding tasks...
            `;
            
            try {
                // Create array of selected tasks
                const selectedTasks = selectedIndices.map(index => aiGeneratedTasks[index]);
                
                // Send request to create tasks
                const response = await fetch('{{ url_for("taskbud.api_create_suggested_tasks") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        goal_id: {{ goal.id }},
                        tasks: selectedTasks,
                        csrf_token: '{{ csrf_token }}'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Hide modal
                    aiTaskModal.hide();
                    
                    // Show success message
                    showToast(`Successfully added ${result.count} task${result.count !== 1 ? 's' : ''}!`);
                    
                    // Reload page to show new tasks
                    window.location.href = result.redirect;
                } else {
                    throw new Error(result.error || 'Failed to create tasks');
                }
            } catch (error) {
                console.error('Error creating tasks:', error);
                
                // Show error state
                aiTaskResults.classList.add('d-none');
                aiError.classList.remove('d-none');
                document.getElementById('aiErrorMessage').textContent = error.message || 'Error creating tasks. Please try again.';
                
                // Reset button
                addAllTasksBtn.innerHTML = `<i class="bi bi-plus-lg me-1"></i> Add Selected Tasks`;
                addAllTasksBtn.disabled = false;
            }
        });
    }

    // Attach event listeners to generate buttons
    if (generateTasksBtn) generateTasksBtn.addEventListener('click', generateTasks);
    if (emptyStateGenerateBtn) emptyStateGenerateBtn.addEventListener('click', generateTasks);
    if (retryGenerateBtn) retryGenerateBtn.addEventListener('click', generateTasks);

    // Add animation to task items on page load
    document.querySelectorAll('.task-item').forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        
        // Stagger animations
        setTimeout(() => {
            item.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
        }, 100 + (index * 50));
    });
});
</script>
{% endblock %}