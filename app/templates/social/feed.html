{% extends 'base.html' %}

{% block content %}
<style>
/* LinkedIn-style feed layout */
.feed-container {
    max-width: 1200px;
    margin: 0 auto;
}

#Con{
    margin-top: 80px;
}

/* Sticky post creator */
.post-creator-card {
    position: sticky;
    top: 15px;
    z-index: 90;
    transition: box-shadow 0.3s ease;
    background: var(--card-bg, white);
    border-radius: 10px;
    border: 1px solid var(--border-color, #e0e0e0);
    margin-bottom: 20px;
}

.post-creator-card.sticky {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.post-creator-compact {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    cursor: pointer;
}

.post-creator-compact .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-color, #4ade80);
    color: white;
    font-weight: bold;
    margin-right: 10px;
}

.post-creator-compact .post-input-placeholder {
    flex-grow: 1;
    padding: 10px 15px;
    border-radius: 35px;
    border: 1px solid #e0e0e0;
    color: var(--text-secondary, #6c757d);
    font-size: 0.9rem;
    background: var(--card-bg, white);
}

.post-actions {
    display: flex;
    justify-content: space-around;
    padding: 8px 0;
    border-top: 1px solid var(--border-color, #e0e0e0);
}

.post-action-btn {
    display: flex;
    align-items: center;
    color: var(--text-secondary, #6c757d);
    font-size: 0.9rem;
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.post-action-btn:hover {
    background-color: var(--hover-overlay, rgba(0, 0, 0, 0.05));
}

.post-action-btn i {
    margin-right: 6px;
    font-size: 1.1rem;
}

/* Post card styling */
.post-card {
    border-radius: 10px;
    border: 1px solid var(--border-color, #e0e0e0);
    background: var(--card-bg, white);
    margin-bottom: 20px;
    overflow: hidden;
    transition: box-shadow 0.3s ease;
}

.post-card:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.post-card .card-header {
    padding: 15px;
    background: var(--card-bg, white);
    border-bottom: 1px solid var(--border-color, #e0e0e0);
}

.post-card .card-body {
    padding: 15px;
}

.post-card .card-footer {
    padding: 10px 15px;
    background: var(--card-bg, white);
    border-top: 1px solid var(--border-color, #e0e0e0);
}

.post-image {
    margin-top: 10px;
    border-radius: 8px;
    overflow: hidden;
}

.post-image img {
    width: 100%;
    max-height: 500px;
    object-fit: cover;
}

/* Comment section */
.comments-section {
    padding: 10px 0;
}

.comment-bubble {
    background-color: var(--hover-overlay, rgba(0, 0, 0, 0.05));
    padding: 10px 15px;
    border-radius: 18px;
    margin-bottom: 5px;
}

/* Like button active state */
.post-action-btn.liked {
    color: var(--primary-color, #4ade80);
    font-weight: 500;
}

/* Mobile Footer Navigation */
.mobile-footer {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: var(--card-bg, white);
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    z-index: 999;
    border-top: 1px solid var(--border-color, #e0e0e0);
    padding-bottom: env(safe-area-inset-bottom, 0);
    transition: transform 0.3s ease;
}

.mobile-footer-hidden {
    transform: translateY(100%);
}

.mobile-footer-nav {
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 8px 0 5px;
    width: 100%;
}

.mobile-footer-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: var(--text-secondary, #6c757d);
    text-decoration: none;
    padding: 5px 0;
    position: relative;
    flex-grow: 1;
    text-align: center;
}

.mobile-footer-item i {
    font-size: 1.25rem;
    margin-bottom: 3px;
}

.mobile-footer-item span {
    font-size: 0.7rem;
}

.mobile-footer-item.active {
    color: var(--primary-color, #4ade80);
}

.create-post-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary-gradient, linear-gradient(145deg, #4ade80, #38bdf8));
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(74, 222, 128, 0.4);
    margin-bottom: 2px;
}

.create-post-icon i {
    color: white;
    font-size: 1.25rem;
    margin: 0;
}

.footer-badge {
    position: absolute;
    top: 0;
    right: calc(50% - 14px);
    background: var(--danger-color, #ef4444);
    color: white;
    font-size: 0.65rem;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--card-bg, white);
}

/* Responsive adjustments */
@media (max-width: 992px) {
    .content-wrapper {
        padding-bottom: 70px;
    }
    
    .mobile-footer {
        display: block;
    }
}

/* Highlight effect for posts */
.highlight-post {
    animation: highlight-fade 2s;
}

@keyframes highlight-fade {
    0% { background-color: rgba(var(--bs-primary-rgb), 0.2); }
    100% { background-color: transparent; }
}

/* Dark mode adjustments */
[data-theme="dark"] .post-card {
    background: var(--card-gradient);
    border-color: var(--border-color);
}

[data-theme="dark"] .post-card .card-header,
[data-theme="dark"] .post-card .card-footer {
    background: var(--card-gradient);
    border-color: var(--border-color);
}

[data-theme="dark"] .post-creator-card {
    background: var(--card-gradient);
    border-color: var(--border-color);
}

[data-theme="dark"] .post-creator-compact .post-input-placeholder {
    background: rgba(255, 255, 255, 0.05);
    border-color: var(--border-color);
    color: var(--text-secondary);
}

[data-theme="dark"] .mobile-footer {
    background: var(--card-gradient);
    border-color: var(--border-color);
}

[data-theme="dark"] .comment-bubble {
    background-color: rgba(255, 255, 255, 0.07);
}

/* Hide welcome text on small screens */
@media (max-width: 768px) {
  .welcome-text h1, .welcome-text p {
    display: none;
  }
  
  .welcome-text {
    display: flex;
    justify-content: flex-end;
  }
  
  #sidebarToggle {
    margin-top: 0 !important;
  }
}

/* Image Modal Styles */
.fullscreen-modal {
  display: none;
  position: fixed;
  z-index: 1060;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background-color: rgba(0, 0, 0, 0.9);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.fullscreen-modal.active {
  display: block;
  opacity: 1;
}

.fullscreen-image-container {
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.fullscreen-image {
  max-width: 95%;
  max-height: 80vh;
  object-fit: contain;
}

.fullscreen-caption {
  color: white;
  max-width: 90%;
  text-align: center;
  margin-top: 20px;
  padding: 10px;
}

.fullscreen-close {
  position: absolute;
  top: 20px;
  right: 30px;
  color: white;
  font-size: 30px;
  font-weight: bold;
  cursor: pointer;
  z-index: 1061;
}

/* Interaction Popups */
.post-interaction-popup {
  position: absolute;
  background: var(--card-bg, white);
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
  min-width: 250px;
  max-width: 300px;
  z-index: 100;
  padding: 12px;
  display: none;
}

.post-interaction-popup.visible {
  display: block;
}

.post-interaction-popup h6 {
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color, #e0e0e0);
}

.post-interaction-list {
  max-height: 250px;
  overflow-y: auto;
  margin: 0;
  padding: 0;
  list-style: none;
}

.post-interaction-item {
  display: flex;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid var(--border-color, #e0e0e0);
}

.post-interaction-item:last-child {
  border-bottom: none;
}

.interaction-user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  margin-right: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
}

.interaction-counter {
  cursor: pointer;
  position: relative;
}

.popup-triangle {
  position: absolute;
  top: -8px;
  left: 20px;
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-bottom: 8px solid var(--card-bg, white);
}

/* Clickable images */
.post-image {
  cursor: zoom-in;
}

/* Dark mode adjustments */
@media (prefers-color-scheme: dark) {
  .post-interaction-popup {
    background: var(--card-bg, #1e293b);
  }
  
  .popup-triangle {
    border-bottom-color: var(--card-bg, #1e293b);
  }
  
  .post-interaction-item {
    border-color: rgba(255, 255, 255, 0.1);
  }
}
</style>

<div class="content-wrapper">
    <div class="feed-container">
        <div class="row">
            <!-- Main Feed Column -->
            <div class="col-lg-8">
                <!-- LinkedIn-style Post Creator Card -->
                <div class="card mb-4 post-creator-card">
                    <div class="card-body p-2">
                        <div class="post-creator-compact" data-bs-toggle="modal" data-bs-target="#createPostModal">
                            <div class="avatar">
                                {% if current_user.profile_picture %}
                                    <img src="{{ url_for('static', filename='uploads/profiles/' ~ current_user.profile_picture) }}" alt="Profile Picture" class="rounded-circle" width="40" height="40">
                                {% else %}
                                    {{ current_user.first_name[0] }}{{ current_user.last_name[0] }}
                                {% endif %}
                            </div>
                            <div class="post-input-placeholder">
                                What's on your mind?
                            </div>
                        </div>
                        <div class="post-actions">
                            <div class="post-action-btn" data-bs-toggle="modal" data-bs-target="#createPostModal">
                                <i class="fas fa-image text-info"></i>
                                <span>Photo</span>
                            </div>
                            <div class="post-action-btn" data-bs-toggle="modal" data-bs-target="#createPostModal">
                                <i class="fas fa-video text-success"></i>
                                <span>Video</span>
                            </div>
                            <div class="post-action-btn" data-bs-toggle="modal" data-bs-target="#createPostModal">
                                <i class="fas fa-calendar-alt text-warning"></i>
                                <span>Event</span>
                            </div>
                            <div class="post-action-btn" data-bs-toggle="modal" data-bs-target="#createPostModal">
                                <i class="fas fa-newspaper text-danger"></i>
                                <span>Article</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Posts Feed -->
                {% if posts %}
                <div id="post-container">
                    {% for post in posts %}
                    <div class="card mb-4 post-card" id="post-{{ post.id }}">
                        <!-- Post Header -->
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="avatar me-3" style="object-fit: cover; width: 40px; height: 40px;">
                                    {% if post.user.profile_picture %}
                                            <img src="{{ url_for('static', filename='uploads/profiles/' ~ current_user.profile_picture) }}"
                                                alt="Profile Picture"
                                                class="rounded-circle"
                                                style="object-fit: cover; width: 40px; height: 40px;">
                                    {% else %}
                                        <h4 class="bg-primary avatar me-3 rounded-circle d-flex align-items-center justify-content-center" 
                                            style="width: 40px; height: 40px; margin: 0;">
                                        {{ post.user.first_name[0] }}{{ post.user.last_name[0] }}
                                        </h4>
                                    {% endif %}
                                </div>
                                <div>
                                    <h5 class="mb-0">
                                        {% if post.user.id == user.id %}
                                            <a href="{{ url_for('auth.profile', user_id=post.user.id) }}" class="text-reset text-decoration-none">
                                                {{ post.user.first_name }} {{ post.user.last_name }}
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('social.view_profile', user_id=post.user.id) }}" class="text-reset text-decoration-none">
                                                {{ post.user.first_name }} {{ post.user.last_name }}
                                            </a>
                                        {% endif %}
                                    </h5>
                                    <small class="text-muted">
                                        {{ post.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                        {% if post.visibility != 'public' %}
                                            {% if post.visibility == 'private' %}
                                                <i class="fas fa-lock ms-2" title="Private"></i>
                                            {% else %}
                                                <i class="fas fa-user-friends ms-2" title="Connections Only"></i>
                                            {% endif %}
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                            
                            {% if post.user_id == current_user.id %}
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-link text-muted" type="button" id="postOptions{{ post.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="postOptions{{ post.id }}">
                                        <li>
                                            <!-- Add data attributes for the delete confirmation modal -->
                                            <a class="dropdown-item text-danger" href="#" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deletePostModal" 
                                                data-post-id="{{ post.id }}">
                                                <i class="fas fa-trash-alt me-2"></i>Delete Post
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Post Content -->
                        <div class="card-body">
                            <p class="card-text">{{ post.content }}</p>
                            
                            <!-- Display Post Image if Available -->
                            {% if post.image_filename %}
                                <div class="post-image mt-2">
                                    <img src="{{ url_for('static', filename='uploads/' + post.image_filename) }}" class="img-fluid rounded" alt="Post image">
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Post Actions -->
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-between mb-2">
                                <div class="interaction-counter" data-post-id="{{ post.id }}">
                                    <i class="fas fa-thumbs-up text-primary"></i> <span class="like-count">{{ post.likes|length }}</span>
                                </div>
                                <div>
                                    <span class="comment-counter" data-bs-toggle="collapse" data-bs-target="#comments{{ post.id }}" aria-expanded="false">
                                        <i class="fas fa-comment text-secondary"></i> {{ post.comments|length }}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-around border-top border-bottom py-2">
                                <button class="btn btn-link text-decoration-none like-button {% if post.likes|selectattr('user_id', 'equalto', current_user.id)|list|length > 0 %}liked{% endif %}" 
                                        data-post-id="{{ post.id }}">
                                    <i class="{% if post.likes|selectattr('user_id', 'equalto', current_user.id)|list|length > 0 %}fas{% else %}far{% endif %} fa-thumbs-up me-1 like-icon"></i> Like
                                </button>
                                
                                <button class="btn btn-link text-decoration-none text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#comments{{ post.id }}" aria-expanded="false">
                                    <i class="fas fa-comment me-1"></i> Comment
                                </button>
                                
                                <button class="btn btn-link text-decoration-none text-muted">
                                    <i class="fas fa-share me-1"></i> Share
                                </button>
                            </div>
                            
                            <!-- Comments Section -->
                            <div class="collapse mt-3" id="comments{{ post.id }}">
                                {% if post.comments %}
                                    <div class="comments-section mb-3">
                                        {% for comment in post.comments %}
                                            <div class="d-flex mb-2">
                                                <div class="avatar bg-secondary me-2" style="width: 32px; height: 32px; font-size: 0.7rem;">
                                                    {{ comment.user.first_name[0] }}{{ comment.user.last_name[0] }}
                                                </div>
                                                <div class="comment-bubble">
                                                    <div class="fw-bold">{{ comment.user.first_name }} {{ comment.user.last_name }}</div>
                                                    <p class="mb-0">{{ comment.content }}</p>
                                                    <small class="text-muted">{{ comment.created_at.strftime('%b %d, %Y') }}</small>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                
                                <!-- Comment Form -->
                                <form method="POST" action="{{ url_for('social.comment_post', post_id=post.id) }}" class="comment-form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="content" placeholder="Write a comment..." required>
                                        <button class="btn btn-primary" type="submit">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div id="loading" class="text-center my-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
                
                    
                    <!-- Pagination -->
                    <nav aria-label="Feed pagination">
                        <ul class="pagination justify-content-center">
                            {% if posts.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('social.feed', page=posts.prev_num) }}">Previous</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Previous</span>
                                </li>
                            {% endif %}
                            
                            {% for page_num in posts.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                {% if page_num %}
                                    {% if posts.page == page_num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% else %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('social.feed', page=page_num) }}">{{ page_num }}</a>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if posts.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('social.feed', page=posts.next_num) }}">Next</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Next</span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% else %}
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-stream fa-4x mb-3 text-muted"></i>
                            <h3>No Posts Yet</h3>
                            <p>Connect with other students or create your first post to see content here!</p>
                            <a href="{{ url_for('social.search') }}" class="btn btn-primary mt-2">Find Students</a>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <!-- Sidebar Column -->
            <div class="col-lg-4">
                <!-- Quick Links - Visible on desktop -->
                <div class="card mb-4 d-none d-lg-block">
                    <div class="card-header">
                        <h2 class="card-title-primary">Quick Links</h2>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            <a href="{{ url_for('social.messages') }}" class="list-group-item list-group-item-action bg-transparent d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-comments me-2"></i> Messages</span>
                                {% if unread_messages_count > 0 %}
                                    <span class="badge bg-danger rounded-pill">{{ unread_messages_count }}</span>
                                {% endif %}
                            </a>
                            <a href="{{ url_for('social.connections') }}" class="list-group-item list-group-item-action bg-transparent d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-user-friends me-2"></i> Connections</span>
                                {% if pending_connections_count > 0 %}
                                    <span class="badge bg-warning rounded-pill">{{ pending_connections_count }}</span>
                                {% endif %}
                            </a>
                            <a href="{{ url_for('social.groups') }}" class="list-group-item list-group-item-action bg-transparent">
                                <i class="fas fa-users me-2"></i> Groups
                            </a>
                            <a href="{{ url_for('social.search') }}" class="list-group-item list-group-item-action bg-transparent">
                                <i class="fas fa-search me-2"></i> Find Students
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Connection Suggestions -->
                <div class="card mb-4" id="Con">
                    <div class="card-header">
                        <h2 class="card-title-secondary">People You May Know</h2>
                    </div>
                    <div class="card-body p-0">
                        {% if connection_suggestions %}
                            <div class="list-group list-group-flush">
                                {% for user in connection_suggestions %}
                                    <div class="list-group-item bg-transparent d-flex align-items-center">
                                        <div class="avatar me-3" style="width: 40px; height: 40px;">
                                            {% if user.profile_picture %}
                                                <img src="{{ url_for('static', filename='uploads/profiles/' ~ user.profile_picture) }}" 
                                                    alt="Profile Picture"
                                                    class="rounded-circle"
                                                    style="width: 40px; height: 40px; object-fit: cover;">
                                            {% else %}
                                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                                                    style="width: 40px; height: 40px;">
                                                    {{ user.first_name[0] }}{{ user.last_name[0] }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0">{{ user.first_name }} {{ user.last_name }}</h6>
                                            <small class="text-muted">{{ user.major }} at {{ user.university }}</small>
                                        </div>
                                        <form method="POST" action="{{ url_for('social.connect', user_id=user.id) }}">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-user-plus"></i> Connect
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <div class="p-3 text-center">
                                <a href="{{ url_for('social.search') }}" class="btn btn-sm btn-outline-secondary">
                                    See More <i class="fas fa-arrow-right"></i>
                                </a>
                            </div>
                        {% else %}
                            <div class="p-4 text-center">
                                <p>No suggestions available right now.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        
    </div>
    
</div>

<!-- Mobile Footer Navigation -->
<div class="mobile-footer">
    <div class="mobile-footer-nav">
        <a href="{{ url_for('social.feed') }}" class="mobile-footer-item active">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="{{ url_for('social.connections') }}" class="mobile-footer-item">
            <i class="fas fa-user-friends"></i>
            <span>Network</span>
        </a>
        <a href="#" class="mobile-footer-item create-post-btn" data-bs-toggle="modal" data-bs-target="#createPostModal">
            <div class="create-post-icon">
                <i class="fas fa-plus"></i>
            </div>
            <span>Post</span>
        </a>
        <a href="{{ url_for('social.messages') }}" class="mobile-footer-item">
            <i class="fas fa-message"></i>
            <span>Chats</span>
            {% if notifications_count > 0 %}
                <span class="footer-badge">{{ notifications_count }}</span>
            {% endif %}
        </a>
        
        <a href="{{ url_for('auth.profile') }}" class="mobile-footer-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
        
    </div>
</div>

<!-- Create Post Modal -->
<div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPostModalLabel">Create Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('social.feed') }}" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <textarea class="form-control" name="content" rows="4" placeholder="What's on your mind?"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalImage" class="form-label">Add Image</label>
                        <input type="file" class="form-control" id="modalImage" name="image" accept="image/*">
                        
                        <!-- Image Preview -->
                        <div id="modalImagePreview" class="mt-2 d-none">
                            <img src="" class="img-thumbnail" style="max-height: 200px">
                            <button type="button" class="btn btn-sm btn-danger mt-1" id="modalRemoveImage">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalVisibility" class="form-label">Visibility</label>
                        <select class="form-select" id="modalVisibility" name="visibility">
                            <option value="public">Public</option>
                            <option value="connections">Connections Only</option>
                            <option value="private">Private</option>
                        </select>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Post</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Post Modal -->
<div class="modal fade" id="deletePostModal" tabindex="-1" aria-labelledby="deletePostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePostModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                    Delete Post
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this post? This action cannot be undone.</p>
                <p class="text-danger fw-bold">All comments and interactions will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deletePostForm" method="POST" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-2"></i>Delete Post
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Fullscreen Image Modal -->
<div class="fullscreen-modal" id="imageModal">
    <span class="fullscreen-close">&times;</span>
    <div class="fullscreen-image-container">
        <img class="fullscreen-image" id="fullscreenImage">
        <div class="fullscreen-caption" id="imageCaption"></div>
    </div>
</div>

<!-- Likes Popup -->
<div class="post-interaction-popup" id="likesPopup">
    <div class="popup-triangle"></div>
    <h6>Likes</h6>
    <ul class="post-interaction-list" id="likesList">
        <!-- Likes will be loaded here -->
    </ul>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Define variables in the correct scope
    let lastScrollTop = 0;
    let page = 2;
    let loading = false;
    let scrollTimeout;
    const postCreator = $('.post-creator-card');
    const mobileFooter = $('.mobile-footer');
    const postCreatorOffset = postCreator.length > 0 ? postCreator.offset().top : 0;

    // Auto-expand textarea as user types
    $('textarea').on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    
    // Handle smooth scrolling to anchors
    if (window.location.hash) {
        const targetElement = $(window.location.hash);
        if (targetElement.length) {
            // Wait for images to load for better positioning
            setTimeout(function() {
                $('html, body').animate({
                    scrollTop: targetElement.offset().top - 70 // Offset for fixed header
                }, 800);
            }, 300);
        }
    }
    
    // Image preview functionality
    $('#modalImage').change(function() {
        const file = this.files[0];
        const previewId = '#modalImagePreview';
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $(previewId + ' img').attr('src', e.target.result);
                $(previewId).removeClass('d-none');
            }
            reader.readAsDataURL(file);
        }
    });
    
    // Remove image button functionality
    $('#modalRemoveImage').click(function() {
        $('#modalImage').val('');
        $('#modalImagePreview').addClass('d-none');
        $('#modalImagePreview img').attr('src', '');
    });
    
    // Throttled scroll handler to improve performance
    $(window).scroll(function() {
        if (!scrollTimeout) {
            scrollTimeout = setTimeout(function() {
                handleScroll();
                scrollTimeout = null;
            }, 50); // Small delay to reduce calculations
        }
    });
    
    // Extracted scroll handling logic
    function handleScroll() {
        const st = $(window).scrollTop();
        const windowHeight = $(window).height();
        const documentHeight = $(document).height();
        const scrollBottom = st + windowHeight;
        
        // Mobile footer behavior - don't hide when near bottom
        const nearFooter = scrollBottom >= documentHeight - 150;
        if (st > lastScrollTop && st > 100 && !nearFooter) {
            mobileFooter.addClass('mobile-footer-hidden');
        } else {
            mobileFooter.removeClass('mobile-footer-hidden');
        }
        
        // Post creator sticky behavior
        if (postCreator.length > 0 && st > postCreatorOffset) {
            postCreator.addClass('sticky');
        } else if (postCreator.length > 0) {
            postCreator.removeClass('sticky');
        }
        
        // Infinite scroll for posts - load earlier to prevent waiting
        if (!loading && scrollBottom >= documentHeight - 300) {
            loadMorePosts();
        }
        
        lastScrollTop = st;
    }
    
    // Extracted post loading logic
    function loadMorePosts() {
        loading = true;
        $('#loading').fadeIn(200);
        
        $.ajax({
            url: "{{ url_for('social.feed') }}?page=" + page,
            type: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function(data) {
                if (data.trim() === '') {
                    $('#loading').fadeOut(200);
                    return;
                }
                
                // Preload any images to prevent layout shifts
                const tempDiv = $(data);
                const images = tempDiv.find('img');
                
                let imagesLoaded = 0;
                const totalImages = images.length;
                
                if (totalImages === 0) {
                    // If no images, just append content
                    $('#post-container').append(data);
                    $('#loading').fadeOut(200);
                    page += 1;
                    loading = false;
                    
                    // Initialize like buttons for new posts
                    initializeLikeButtons();
                } else {
                    // If has images, preload them first
                    images.each(function() {
                        const img = new Image();
                        img.onload = img.onerror = function() {
                            imagesLoaded++;
                            if (imagesLoaded === totalImages) {
                                $('#post-container').append(data);
                                $('#loading').fadeOut(200);
                                page += 1;
                                loading = false;
                                
                                // Initialize like buttons for new posts
                                initializeLikeButtons();
                            }
                        };
                        img.src = this.src;
                    });
                    
                    // Safety timeout in case images don't load
                    setTimeout(function() {
                        if (loading) {
                            $('#post-container').append(data);
                            $('#loading').fadeOut(200);
                            page += 1;
                            loading = false;
                            
                            // Initialize like buttons for new posts
                            initializeLikeButtons();
                        }
                    }, 3000);
                }
            },
            error: function() {
                $('#loading').fadeOut(200);
                loading = false;
            }
        });
    }

    // Function to parse URL parameters
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
    
    // Handle smooth scrolling to anchors with a delay to ensure content is loaded
    if (window.location.hash) {
        const targetId = window.location.hash;
        const targetElement = $(targetId);
        
        if (targetElement.length) {
            // Wait for images and content to load
            setTimeout(function() {
                // Smooth scroll to the element
                $('html, body').animate({
                    scrollTop: targetElement.offset().top - 70 // Adjust for header height
                }, 800);
                
                // Flash effect to highlight the post
                $(targetId).addClass('highlight-post');
                setTimeout(function() {
                    $(targetId).removeClass('highlight-post');
                }, 2000);
            }, 500);
        }
    }
    
    // If a show_comments parameter exists, expand that comments section
    const showCommentsFor = getUrlParameter('show_comments');
    if (showCommentsFor) {
        setTimeout(function() {
            $('#comments' + showCommentsFor).collapse('show');
            
            // Focus on the comment input if we're coming from a comment action
            if (window.location.pathname.includes('/comment')) {
                $('#comments' + showCommentsFor + ' input[name="content"]').focus();
            }
        }, 1000);
    }
    
    // Setup the delete post modal
    const deletePostModal = document.getElementById('deletePostModal');
    if (deletePostModal) {
        deletePostModal.addEventListener('show.bs.modal', function(event) {
            // Button that triggered the modal
            const button = event.relatedTarget;
            
            // Extract post id from the button's data attribute
            const postId = button.getAttribute('data-post-id');
            
            // Update the form's action URL with the post id
            const form = this.querySelector('#deletePostForm');
            form.action = "{{ url_for('social.delete_post_route', post_id=0) }}".replace('/0', '/' + postId);
        });
    }
    
    // Initialize like buttons
    function initializeLikeButtons() {
        $('.like-button').off('click').on('click', function(e) {
            e.preventDefault();
            
            const button = $(this);
            const postId = button.data('post-id');
            const likeCount = button.closest('.card-footer').find('.like-count');
            const likeIcon = button.find('.like-icon');
            
            // Prevent multiple clicks
            if (button.hasClass('processing')) {
                return;
            }
            
            button.addClass('processing');
            
            // Visual feedback immediately
            if (button.hasClass('liked')) {
                // Unlike action
                likeCount.text(parseInt(likeCount.text()) - 1);
                likeIcon.removeClass('fas').addClass('far');
                button.removeClass('liked');
                
                // Send AJAX request
                $.ajax({
                    url: "{{ url_for('social.unlike_post_route', post_id=0) }}".replace('0', postId),
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': $('input[name="csrf_token"]').val()
                    },
                    success: function(response) {
                        button.removeClass('processing');
                    },
                    error: function() {
                        // Revert on error
                        likeCount.text(parseInt(likeCount.text()) + 1);
                        likeIcon.removeClass('far').addClass('fas');
                        button.addClass('liked');
                        button.removeClass('processing');
                    }
                });
            } else {
                // Like action
                likeCount.text(parseInt(likeCount.text()) + 1);
                likeIcon.removeClass('far').addClass('fas');
                button.addClass('liked');
                
                // Send AJAX request
                $.ajax({
                    url: "{{ url_for('social.like_post_route', post_id=0) }}".replace('0', postId),
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': $('input[name="csrf_token"]').val()
                    },
                    success: function(response) {
                        button.removeClass('processing');
                    },
                    error: function() {
                        // Revert on error
                        likeCount.text(parseInt(likeCount.text()) - 1);
                        likeIcon.removeClass('fas').addClass('far');
                        button.removeClass('liked');
                        button.removeClass('processing');
                    }
                });
            }
        });
    }
    
    // Initialize like buttons on page load
    initializeLikeButtons();
    
    // Handle comment form submission with AJAX
    $('.comment-form').submit(function(e) {
        e.preventDefault();
        
        const form = $(this);
        const url = form.attr('action');
        const formData = form.serialize();
        const commentInput = form.find('input[name="content"]');
        const commentsSection = form.prev('.comments-section');
        const commentCounter = form.closest('.card-footer').find('.comment-counter');
        
        // Disable input during submission
        commentInput.prop('disabled', true);
        
        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            success: function(response) {
                // Create a new comment element
                const commentHtml = `
                    <div class="d-flex mb-2">
                        <div class="avatar bg-secondary me-2" style="width: 32px; height: 32px; font-size: 0.7rem;">
                            {{ current_user.first_name[0] }}{{ current_user.last_name[0] }}
                        </div>
                        <div class="comment-bubble">
                            <div class="fw-bold">{{ current_user.first_name }} {{ current_user.last_name }}</div>
                            <p class="mb-0">${commentInput.val()}</p>
                            <small class="text-muted">Just now</small>
                        </div>
                    </div>
                `;
                
                // If comments section doesn't exist, create it
                if (commentsSection.length === 0) {
                    form.before('<div class="comments-section mb-3"></div>');
                    commentsSection = form.prev('.comments-section');
                }
                
                // Add the new comment
                commentsSection.append(commentHtml);
                
                // Update comment count
                const currentCount = parseInt(commentCounter.text().trim());
                commentCounter.html(`<i class="fas fa-comment text-secondary"></i> ${currentCount + 1}`);
                
                // Clear and enable input
                commentInput.val('').prop('disabled', false).focus();
            },
            error: function() {
                alert('Error posting comment. Please try again.');
                commentInput.prop('disabled', false);
            }
        });
    });
    
    // Image modal functionality
    $('.post-image img').click(function() {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('fullscreenImage');
        const captionText = document.getElementById('imageCaption');
        
        modal.classList.add('active');
        modalImg.src = this.src;
        captionText.innerHTML = this.alt || '';
    });
    
    $('.fullscreen-close').click(function() {
        document.getElementById('imageModal').classList.remove('active');
    });
    
    // Close modal when clicking outside the image
    $('#imageModal').click(function(e) {
        if (e.target === this) {
            $(this).removeClass('active');
        }
    });
    
    // Likes popup functionality
    $('.interaction-counter').click(function() {
        const postId = $(this).data('post-id');
        const popup = $('#likesPopup');
        const likesList = $('#likesList');
        
        // Position the popup
        const rect = this[0].getBoundingClientRect();
        popup.css({
            top: rect.bottom + window.scrollY + 10,
            left: rect.left + window.scrollX
        });
        
        // Show loading
        likesList.html('<li class="text-center py-2"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></li>');
        popup.addClass('visible');
        
        // Load likes
        $.ajax({
            url: `/social/post/${postId}/likes`,
            type: 'GET',
            success: function(response) {
                if (response.likes && response.likes.length > 0) {
                    let html = '';
                    response.likes.forEach(like => {
                        html += `
                            <li class="post-interaction-item">
                                <div class="interaction-user-avatar bg-primary">
                                    ${like.user.first_name[0]}${like.user.last_name[0]}
                                </div>
                                <span>${like.user.first_name} ${like.user.last_name}</span>
                            </li>
                        `;
                    });
                    likesList.html(html);
                } else {
                    likesList.html('<li class="text-center py-2">No likes yet</li>');
                }
            },
            error: function() {
                likesList.html('<li class="text-center py-2 text-danger">Error loading likes</li>');
            }
        });
        
        // Close popup when clicking outside
        $(document).one('click', function(e) {
            if (!$(e.target).closest('.post-interaction-popup, .interaction-counter').length) {
                popup.removeClass('visible');
            }
        });
        
        return false; // Prevent event propagation
    });
});
</script>
{% endblock %}